<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifying Management - Noobly JS Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5.10.5/swagger-ui.css">
    <link rel="stylesheet" href="/services/css/navigation.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="app-container">
        <nav class="sidebar" id="navigation-sidebar"></nav>

        <main class="main-content">
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h1 class="page-title">Notification Management</h1>
                        <p class="page-subtitle">Monitor topics, subscribers, and notification activity</p>
                    </div>
                    <div style="min-width: 250px;">
                        <label class="form-label mb-1" for="instanceSelect">Notifying Instance:</label>
                        <select id="instanceSelect" class="form-select form-select-sm">
                            <option value="default">default</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="alert alert-success" id="successAlert">
                <strong>Success!</strong> <span id="successMessage"></span>
            </div>

            <div class="alert alert-error" id="errorAlert">
                <strong>Error!</strong> <span id="errorMessage"></span>
            </div>

            <ul class="nav nav-tabs mb-4" id="notifyingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="false">
                        <i class="bi bi-database"></i> Data
                    </button>
                </li>
                            <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="notifyingTabContent">
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                    <!-- Settings Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Notifying Service Settings</h2>
                            <p class="card-subtitle">Configure the notifying service parameters</p>
                        </div>
                        <div class="card-content">
                            <div id="settingsInfo" class="alert alert-info mb-4" style="display: none;"></div>
                            <form id="settingsForm">
                                <div id="settingsFormFields"></div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                    <button type="button" class="btn btn-secondary" onclick="loadSettings()">Reload</button>
                                </div>
                            </form>
                            <div id="settingsSaveResponse" class="response-container" style="display: none; margin-top: 1rem;">
                                <div class="response-title">Save Response:</div>
                                <div id="settingsSaveResponseContent" class="response-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="card-title">Notification Overview</h2>
                                <p class="card-subtitle">
                                    Aggregate insight into topics and messages
                                    <span id="instanceLabel" style="font-size: 0.85rem; color: #6c757d; margin-left: 1rem;">
                                        (Instance: <span id="instanceBadge" style="font-weight: 600;">default</span>)
                                    </span>
                                </p>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="spinner-border spinner-border-sm text-secondary d-none" id="analyticsRefreshSpinner" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <button type="button" class="btn btn-primary btn-sm" id="analyticsRefreshButton">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="metrics-summary">
                                <div class="summary-item">
                                    <h5>Total Topics</h5>
                                    <div class="summary-value" id="totalTopics">0</div>
                                    <div class="summary-meta">Distinct topics created</div>
                                </div>
                                <div class="summary-item">
                                    <h5>Total Subscribers</h5>
                                    <div class="summary-value" id="totalSubscribers">0</div>
                                    <div class="summary-meta">Subscribers across all topics</div>
                                </div>
                                <div class="summary-item">
                                    <h5>Total Notifications</h5>
                                    <div class="summary-value" id="totalNotifications">0</div>
                                    <div class="summary-meta">Messages delivered to topics</div>
                                </div>
                                <div class="summary-item">
                                    <h5>Last Notification</h5>
                                    <div class="summary-value" id="lastNotification">—</div>
                                    <div class="summary-meta">Most recent publish time</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h2 class="card-title mb-0">Top Topics by Activity</h2>
                            <p class="card-subtitle">Top 10 topics ranked by notifications delivered</p>
                        </div>
                        <div class="card-content">
                            <div class="list-group list-group-flush" id="topTopicsList">
                                <div class="list-group-item loading-row">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading topics...
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title mb-0">Top Topics (Last Activity)</h2>
                            <p class="card-subtitle">Latest 100 topics ordered by last publish time</p>
                        </div>
                        <div class="card-content">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>Topic Name</th>
                                            <th>Count of Subscribers</th>
                                            <th>Count of Posts</th>
                                            <th>Date Last Post</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topicsTableBody">
                                        <tr class="loading-row">
                                            <td colspan="4">
                                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                Loading topics...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted small">
                                    <span id="topicsRowCount">0</span> topics displayed
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Send Notification</h2>
                            <p class="card-subtitle">Send a new notification payload</p>
                        </div>
                        <div class="card-content">
                            <form id="sendForm">
                                <div class="form-group">
                                    <label class="form-label" for="sendMessage">Message (JSON)</label>
                                    <textarea id="sendMessage" class="form-input form-textarea" placeholder='{"channel": "email", "recipient": "test@test.com", "subject": "Hello!", "body": "This is a test notification."}' required></textarea>
                                    <div id="sendValidation" class="validation-message" style="display: none;"></div>
                                    <div class="helper-text">Enter a valid JSON object for the notification</div>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                    <button type="button" class="btn btn-secondary" id="formatSendButton">Format JSON</button>
                                    <button type="button" class="btn btn-secondary" id="exampleSendButton">Load Example</button>
                                </div>
                            </form>
                            <div id="sendResponse" class="response-container" style="display: none;">
                                <div class="response-title">Response:</div>
                                <div id="sendResponseContent" class="response-content"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Service Status</h2>
                            <p class="card-subtitle">Check notifying service status</p>
                        </div>
                        <div class="card-content">
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" id="statusButton">Check Status</button>
                            </div>
                            <div id="statusResponse" class="response-container" style="display: none;">
                                <div class="response-title">Service Status:</div>
                                <div id="statusResponseContent" class="response-content"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">API Documentation</h2>
                            <p class="card-subtitle">Interactive API documentation for Notifying service</p>
                        </div>
                        <div class="card-content">
                            <div id="swagger-ui"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.10.5/swagger-ui-bundle.js"></script>
    <script src="/services/js/navigation.js"></script>
    <script src="/services/notifying/scripts"></script>
    <script>
        NooblyNavigation.renderNavigation('navigation-sidebar', 'notifying');
    </script>
    <script>
        // Global variable to track current instance
        let currentInstance = 'default';
        const numberFormatter = new Intl.NumberFormat();

        /**
         * Gets the current instance name
         * @returns {string} The selected instance name
         */
        function getCurrentInstance() {
            const select = document.getElementById('instanceSelect');
            return select ? select.value : 'default';
        }

        /**
         * Gets the API path for instance-specific endpoints
         * @param {string} basePath - The base API path
         * @returns {string} The full API path with instance if not default
         */
        function getInstanceApiPath(basePath) {
            const instance = getCurrentInstance();
            if (instance === 'default') {
                return basePath;
            }
            // Insert instance name after /api/ in the path
            return basePath.replace('/api/', `/api/${instance}/`);
        }

        /**
         * Loads available instances and populates the dropdown
         */
        async function loadInstances() {
            try {
                const response = await fetch('/services/notifying/api/instances');
                if (!response.ok) {
                    throw new Error(`Failed to load instances: ${response.status}`);
                }
                const data = await response.json();
                const instances = data.instances || ['default'];

                const select = document.getElementById('instanceSelect');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    instances.forEach((instance) => {
                        const option = document.createElement('option');
                        option.value = instance;
                        option.textContent = instance;
                        select.appendChild(option);
                    });
                    if (instances.includes(currentValue)) {
                        select.value = currentValue;
                    } else {
                        select.value = 'default';
                    }
                }
            } catch (error) {
                console.error('Error loading instances:', error);
            }
        }

        function formatNumber(value) {
            if (typeof value !== 'number' || !Number.isFinite(value)) {
                return '0';
            }
            return numberFormatter.format(value);
        }

        function formatDate(value) {
            if (!value) {
                return '—';
            }
            try {
                return new Date(value).toLocaleString();
            } catch (error) {
                return value;
            }
        }

        function validateJSON(elementId) {
            const element = document.getElementById(elementId);
            const validation = document.getElementById(elementId.replace('Message', 'Validation'));
            if (!element || !validation) {
                return true;
            }

            const value = element.value.trim();

            if (!value) {
                element.classList.remove('json-valid', 'json-invalid');
                validation.style.display = 'none';
                return true;
            }

            try {
                JSON.parse(value);
                element.classList.remove('json-invalid');
                element.classList.add('json-valid');
                validation.textContent = '✓ Valid JSON';
                validation.className = 'validation-message validation-success';
                validation.style.display = 'block';
                return true;
            } catch (error) {
                element.classList.remove('json-valid');
                element.classList.add('json-invalid');
                validation.textContent = '✗ Invalid JSON: ' + error.message;
                validation.className = 'validation-message validation-error';
                validation.style.display = 'block';
                return false;
            }
        }

        function showAlert(message, type = 'success') {
            const alertElement = document.getElementById(type + 'Alert');
            const messageElement = document.getElementById(type + 'Message');
            if (!alertElement || !messageElement) {
                return;
            }
            messageElement.textContent = message;
            alertElement.classList.add('show');
            setTimeout(() => alertElement.classList.remove('show'), 5000);
        }

        function showResponse(containerId, contentId, data) {
            const container = document.getElementById(containerId);
            const content = document.getElementById(contentId);
            if (!container || !content) {
                return;
            }
            content.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            container.style.display = 'block';
        }

        function setLoading(elementId, isLoading) {
            const element = document.getElementById(elementId);
            if (!element) {
                return;
            }
            element.classList.toggle('loading', Boolean(isLoading));
        }


        function toggleAnalyticsLoading(isLoading) {
            const button = document.getElementById('analyticsRefreshButton');
            const spinner = document.getElementById('analyticsRefreshSpinner');
            if (button) {
                button.disabled = Boolean(isLoading);
            }
            if (spinner) {
                spinner.classList.toggle('d-none', !isLoading);
            }
        }

        function setAnalyticsPlaceholders() {
            const list = document.getElementById('topTopicsList');
            const tableBody = document.getElementById('topicsTableBody');
            if (list) {
                list.innerHTML = `
                    <div class="list-group-item loading-row">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading topics...
                    </div>`;
            }
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr class="loading-row">
                        <td colspan="4">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading topics...
                        </td>
                    </tr>`;
            }
            const rowCount = document.getElementById('topicsRowCount');
            if (rowCount) {
                rowCount.textContent = '0';
            }
        }

        async function fetchAnalytics(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed request with status ${response.status}`);
            }
            return response.json();
        }

        function updateInstanceDisplay() {
            const instanceBadge = document.getElementById('instanceBadge');
            if (instanceBadge) {
                instanceBadge.textContent = getCurrentInstance();
            }
        }

        function renderOverview(data) {
            const {
                topics = 0,
                subscribers = 0,
                notifications = 0,
                lastNotificationAt = null,
            } = data || {};

            const totalTopics = document.getElementById('totalTopics');
            const totalSubscribers = document.getElementById('totalSubscribers');
            const totalNotifications = document.getElementById('totalNotifications');
            const lastNotification = document.getElementById('lastNotification');

            if (totalTopics) totalTopics.textContent = formatNumber(topics);
            if (totalSubscribers) totalSubscribers.textContent = formatNumber(subscribers);
            if (totalNotifications) totalNotifications.textContent = formatNumber(notifications);
            if (lastNotification) lastNotification.textContent = formatDate(lastNotificationAt);

            // Update instance display
            updateInstanceDisplay();
        }

        function renderTopTopics(topics) {
            const list = document.getElementById('topTopicsList');
            if (!list) {
                return;
            }

            list.innerHTML = '';

            if (!topics || topics.length === 0) {
                list.innerHTML = '<div class="list-group-item text-muted">No topics captured yet.</div>';
                return;
            }

            topics.forEach((topic, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';

                const details = document.createElement('div');
                const name = document.createElement('div');
                name.className = 'fw-semibold';
                name.textContent = `${index + 1}. ${topic.topic}`;

                const meta = document.createElement('div');
                meta.className = 'text-muted small';
                meta.textContent = `Subscribers: ${formatNumber(topic.subscriberCount)} • Posts: ${formatNumber(topic.notificationCount)} • Last post: ${formatDate(topic.lastNotificationAt)}`;

                details.appendChild(name);
                details.appendChild(meta);

                const badge = document.createElement('span');
                badge.className = 'badge bg-primary rounded-pill';
                badge.textContent = formatNumber(topic.notificationCount);

                item.appendChild(details);
                item.appendChild(badge);

                list.appendChild(item);
            });
        }

        function renderTopicsTable(topics) {
            const tableBody = document.getElementById('topicsTableBody');
            const rowCount = document.getElementById('topicsRowCount');
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = '';

            if (!topics || topics.length === 0) {
                tableBody.innerHTML = `
                    <tr class="loading-row">
                        <td colspan="4">No topic activity recorded yet.</td>
                    </tr>`;
                if (rowCount) {
                    rowCount.textContent = '0';
                }
                return;
            }

            topics.forEach((topic) => {
                const row = document.createElement('tr');

                const topicCell = document.createElement('td');
                topicCell.textContent = topic.topic;

                const subscribersCell = document.createElement('td');
                subscribersCell.textContent = formatNumber(topic.subscriberCount);

                const notificationsCell = document.createElement('td');
                notificationsCell.textContent = formatNumber(topic.notificationCount);

                const lastPostCell = document.createElement('td');
                lastPostCell.textContent = formatDate(topic.lastNotificationAt);

                row.appendChild(topicCell);
                row.appendChild(subscribersCell);
                row.appendChild(notificationsCell);
                row.appendChild(lastPostCell);
                tableBody.appendChild(row);
            });

            if (rowCount) {
                rowCount.textContent = String(topics.length);
            }
        }

        async function loadAnalytics() {
            toggleAnalyticsLoading(true);
            setAnalyticsPlaceholders();
            try {
                const [overview, topTopicsPayload, topicsPayload] = await Promise.all([
                    fetchAnalytics(getInstanceApiPath('/services/notifying/api/analytics/overview')),
                    fetchAnalytics(getInstanceApiPath('/services/notifying/api/analytics/top-topics?limit=10')),
                    fetchAnalytics(getInstanceApiPath('/services/notifying/api/analytics/topics?limit=100')),
                ]);

                renderOverview(overview);
                renderTopTopics((topTopicsPayload && topTopicsPayload.topics) || []);
                renderTopicsTable((topicsPayload && topicsPayload.topics) || []);
            } catch (error) {
                showAlert('Error loading analytics: ' + error.message, 'error');
            } finally {
                toggleAnalyticsLoading(false);
            }
        }

        async function checkStatus() {
            try {
                const instanceName = getCurrentInstance();
                const notifying = new nooblyjsNotifying({ instanceName });
                const result = await notifying.getStatus();
                showResponse('statusResponse', 'statusResponseContent', result);
                showAlert('Status checked successfully');
            } catch (error) {
                showAlert('Error checking status: ' + error.message, 'error');
                showResponse('statusResponse', 'statusResponseContent', 'Error: ' + error.message);
            }
        }

        async function initializeSwagger() {
            try {
                // Fetch the Swagger specification from the API endpoint
                const response = await fetch(getInstanceApiPath('/services/notifying/api/swagger/docs.json'));
                if (!response.ok) {
                    throw new Error(`Failed to load Swagger docs: ${response.status}`);
                }
                const spec = await response.json();

                // Initialize Swagger UI with the fetched specification
                SwaggerUIBundle({
                    spec,
                    dom_id: '#swagger-ui',
                    deepLinking: true,
                    presets: [SwaggerUIBundle.presets.apis, SwaggerUIBundle.presets.standalone],
                    plugins: [SwaggerUIBundle.plugins.DownloadUrl],
                    layout: 'BaseLayout',
                    tryItOutEnabled: true,
                });
            } catch (error) {
                console.error('Error initializing Swagger UI:', error);
                const swaggerContainer = document.getElementById('swagger-ui');
                if (swaggerContainer) {
                    swaggerContainer.innerHTML =
                        '<p class="text-danger">Error loading API documentation. Please refresh the page.</p>';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load instances and set up instance change listener
            loadInstances();

            const instanceSelect = document.getElementById('instanceSelect');
            if (instanceSelect) {
                instanceSelect.addEventListener('change', () => {
                    currentInstance = getCurrentInstance();
                    loadAnalytics();
                    checkStatus();
                    // Store instance preference in localStorage
                    localStorage.setItem('notifying-instance-preference', currentInstance);
                });
            }

            // Restore instance preference from localStorage
            const savedInstance = localStorage.getItem('notifying-instance-preference');
            if (savedInstance && instanceSelect) {
                instanceSelect.value = savedInstance;
                currentInstance = savedInstance;
            }

            const sendMessageInput = document.getElementById('sendMessage');
            if (sendMessageInput) {
                sendMessageInput.addEventListener('input', () => validateJSON('sendMessage'));
            }

            const formatButton = document.getElementById('formatSendButton');
            if (formatButton) {
                formatButton.addEventListener('click', () => {
                    const element = document.getElementById('sendMessage');
                    if (!element) {
                        return;
                    }
                    try {
                        const parsed = JSON.parse(element.value);
                        element.value = JSON.stringify(parsed, null, 2);
                        validateJSON('sendMessage');
                    } catch (error) {
                        showAlert('Invalid JSON cannot be formatted', 'error');
                    }
                });
            }

            const exampleButton = document.getElementById('exampleSendButton');
            if (exampleButton) {
                exampleButton.addEventListener('click', () => {
                    const element = document.getElementById('sendMessage');
                    if (!element) {
                        return;
                    }
                    const example = {
                        channel: 'sms',
                        recipient: '+1234567890',
                        body: 'Your package has been shipped!',
                    };
                    element.value = JSON.stringify(example, null, 2);
                    validateJSON('sendMessage');
                });
            }

            const sendForm = document.getElementById('sendForm');
            if (sendForm) {
                sendForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!validateJSON('sendMessage')) {
                        showAlert('Please enter a valid JSON notification message', 'error');
                        return;
                    }

                    try {
                        setLoading('sendForm', true);
                        const instanceName = getCurrentInstance();
                        const notifying = new nooblyjsNotifying({ instanceName });
                        const message = JSON.parse(document.getElementById('sendMessage').value);

                        // Use the client library to send notification to the 'admin-notifications' topic
                        const result = await notifying.notify('admin-notifications', message);
                        showResponse('sendResponse', 'sendResponseContent', result);
                        showAlert('Notification sent successfully');
                    } catch (error) {
                        showAlert('Error sending notification: ' + error.message, 'error');
                        showResponse('sendResponse', 'sendResponseContent', 'Error: ' + error.message);
                    } finally {
                        setLoading('sendForm', false);
                    }
                });
            }

            const statusButton = document.getElementById('statusButton');
            if (statusButton) {
                statusButton.addEventListener('click', () => checkStatus());
            }

            const refreshButton = document.getElementById('analyticsRefreshButton');
            if (refreshButton) {
                refreshButton.addEventListener('click', () => loadAnalytics());
            }
        });

        window.addEventListener('load', () => {
            loadAnalytics();
            checkStatus();
            initializeSwagger();
        });
    
        // Settings functionality
        let currentSettings = {};

        // Fetch settings from API
        async function loadSettings() {
            try {
                const response = await fetch(getInstanceApiPath('/services/notifying/api/settings'));
                const data = await response.json();
                currentSettings = data;
                renderSettingsForm(data);
            } catch (error) {
                showAlert('Error loading settings: ' + error.message, 'error');
                console.error('Error loading settings:', error);
            }
        }

        // Render settings form based on settings structure
        function renderSettingsForm(data) {
            const formFieldsContainer = document.getElementById('settingsFormFields');
            const infoContainer = document.getElementById('settingsInfo');

            // Clear existing form fields
            formFieldsContainer.innerHTML = '';

            // Display description if available
            if (data.description) {
                infoContainer.textContent = data.description;
                infoContainer.style.display = 'block';
            }

            // Render form fields from settings list
            if (data.list && Array.isArray(data.list)) {
                data.list.forEach((setting) => {
                    const formGroup = createFormField(setting, data);
                    formFieldsContainer.appendChild(formGroup);
                });
            }
        }

        // Create form field based on setting type
        function createFormField(setting, settingsData) {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group mb-3';

            // Create label
            const label = document.createElement('label');
            label.className = 'form-label';
            label.htmlFor = 'setting_' + setting.setting;
            label.textContent = setting.setting;
            formGroup.appendChild(label);

            // Get current value from settings
            const currentValue = settingsData[setting.setting] || '';

            // Create input based on type
            let input;
            switch (setting.type) {
                case 'string':
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;
                    input.value = currentValue;
                    if (setting.values && setting.values.length > 0) {
                        input.placeholder = setting.values[0];
                    }
                    break;

                case 'integer':
                    input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;
                    input.value = currentValue;
                    input.step = '1';
                    break;

                case 'number':
                    input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;
                    input.value = currentValue;
                    input.step = 'any';
                    break;

                case 'boolean':
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;
                    input.checked = currentValue === true || currentValue === 'true';
                    break;

                case 'date':
                    input = document.createElement('input');
                    input.type = 'date';
                    input.className = 'form-control';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;
                    input.value = currentValue;
                    break;

                case 'list':
                case 'options':
                    input = document.createElement('select');
                    input.className = 'form-select';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;

                    // Add options
                    if (setting.values && Array.isArray(setting.values)) {
                        setting.values.forEach((value) => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.textContent = value;
                            if (value === currentValue) {
                                option.selected = true;
                            }
                            input.appendChild(option);
                        });
                    }
                    break;

                default:
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = 'setting_' + setting.setting;
                    input.name = setting.setting;
                    input.value = currentValue;
            }

            formGroup.appendChild(input);

            // Add description helper text if available
            if (setting.description) {
                const helperText = document.createElement('div');
                helperText.className = 'form-text';
                helperText.textContent = setting.description;
                formGroup.appendChild(helperText);
            }

            return formGroup;
        }

        // Handle settings form submission
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                // Collect form data
                const formData = new FormData(document.getElementById('settingsForm'));
                const payload = {};

                // Build payload from form fields
                for (let [key, value] of formData.entries()) {
                    // Handle checkboxes
                    if (document.getElementById('setting_' + key)?.type === 'checkbox') {
                        payload[key] = document.getElementById('setting_' + key).checked;
                    } else {
                        payload[key] = value;
                    }
                }

                // Send to API
                const response = await fetch(getInstanceApiPath('/services/notifying/api/settings'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const responseText = await response.text();

                // Show response
                showResponse('settingsSaveResponse', 'settingsSaveResponseContent', responseText);

                if (response.ok) {
                    showAlert('Settings saved successfully', 'success');
                    // Reload settings to reflect changes
                    setTimeout(() => loadSettings(), 1000);
                } else {
                    showAlert('Error saving settings: ' + responseText, 'error');
                }
            } catch (error) {
                showAlert('Error saving settings: ' + error.message, 'error');
                showResponse('settingsSaveResponse', 'settingsSaveResponseContent', 'Error: ' + error.message);
            }
        });

        // Load settings when settings tab is shown
        document.getElementById('settings-tab')?.addEventListener('shown.bs.tab', function (e) {
            loadSettings();
        });

        </script>
</body>
</html>
